<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
      * {
        box-sizing: border-box;
      }

      body {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        margin: 0;
        padding: 20px;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .container {
        background: white;
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        width: 100%;
        max-width: 640px;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
        color: white;
        padding: 32px 40px;
        text-align: center;
      }

      .header h1 {
        margin: 0 0 8px 0;
        font-size: 1.75rem;
        font-weight: 700;
        letter-spacing: -0.5px;
      }

      .header p {
        margin: 0;
        opacity: 0.8;
        font-size: 0.95rem;
        font-weight: 400;
      }

      .content {
        padding: 40px;
      }

      /* Form Styles */
      .form-group {
        margin-bottom: 24px;
      }

      label {
        display: block;
        font-size: 0.875rem;
        font-weight: 600;
        color: #374151;
        margin-bottom: 8px;
      }

      input[type="text"] {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        transition: all 0.2s ease;
      }

      input[type="text"]:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      }

      textarea {
        width: 100%;
        padding: 14px 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 0.95rem;
        font-family: inherit;
        line-height: 1.6;
        resize: vertical;
        min-height: 200px;
        transition: all 0.2s ease;
      }

      textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
      }

      .char-count {
        display: flex;
        justify-content: flex-end;
        margin-top: 8px;
        font-size: 0.8rem;
        color: #6b7280;
      }

      .char-count.warning {
        color: #f59e0b;
      }

      .char-count.error {
        color: #ef4444;
        font-weight: 600;
      }

      /* Button Styles */
      .btn {
        width: 100%;
        padding: 16px 24px;
        border: none;
        border-radius: 10px;
        font-size: 1rem;
        font-weight: 600;
        font-family: inherit;
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -10px rgba(102, 126, 234, 0.5);
      }

      .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }

      .btn-success {
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        color: white;
      }

      .btn-success:hover:not(:disabled) {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px -10px rgba(16, 185, 129, 0.5);
      }

      /* Spinner */
      .spinner {
        width: 20px;
        height: 20px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-top-color: white;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Screen States */
      .screen {
        display: none;
      }

      .screen.active {
        display: block;
      }

      /* Success Screen */
      .success-icon {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
      }

      .success-icon svg {
        width: 40px;
        height: 40px;
        color: white;
      }

      .success-content {
        text-align: center;
      }

      .success-content h2 {
        color: #1f2937;
        font-size: 1.5rem;
        margin: 0 0 12px 0;
        font-weight: 700;
      }

      .success-content p {
        color: #6b7280;
        line-height: 1.6;
        margin: 0 0 8px 0;
      }

      .student-name {
        display: inline-block;
        background: #f3f4f6;
        padding: 8px 16px;
        border-radius: 8px;
        font-weight: 600;
        color: #374151;
        margin: 16px 0 24px;
      }

      .divider {
        height: 1px;
        background: #e5e7eb;
        margin: 32px 0;
      }

      .instructions {
        background: #fef3c7;
        border: 1px solid #fcd34d;
        border-radius: 10px;
        padding: 16px 20px;
        margin-bottom: 24px;
      }

      .instructions h3 {
        color: #92400e;
        font-size: 0.9rem;
        font-weight: 600;
        margin: 0 0 8px 0;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .instructions p {
        color: #78350f;
        font-size: 0.875rem;
        margin: 0;
        line-height: 1.5;
      }

      /* Defense Screen */
      .defense-header {
        text-align: center;
        margin-bottom: 24px;
      }

      .defense-header h2 {
        color: #1f2937;
        font-size: 1.25rem;
        margin: 0 0 8px 0;
      }

      .defense-header p {
        color: #6b7280;
        margin: 0;
        font-size: 0.9rem;
      }

      .widget-container {
        background: #f9fafb;
        border-radius: 12px;
        padding: 24px;
        min-height: 120px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .widget-container.loading {
        color: #6b7280;
        font-size: 0.9rem;
      }

      /* Status Badge */
      .status-badge {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 12px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .status-badge.ready {
        background: #d1fae5;
        color: #065f46;
      }

      .status-badge .dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Back link */
      .back-link {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        color: #6b7280;
        text-decoration: none;
        font-size: 0.875rem;
        margin-bottom: 16px;
        transition: color 0.2s;
      }

      .back-link:hover {
        color: #374151;
      }

      /* Defense Complete Screen */
      .complete-icon {
        width: 100px;
        height: 100px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin: 0 auto 24px;
      }

      .complete-icon svg {
        width: 50px;
        height: 50px;
        color: white;
      }

      .complete-content {
        text-align: center;
      }

      .complete-content h2 {
        color: #1f2937;
        font-size: 1.75rem;
        margin: 0 0 16px 0;
        font-weight: 700;
      }

      .complete-content p {
        color: #6b7280;
        line-height: 1.6;
        margin: 0 0 8px 0;
      }

      .complete-content .thank-you {
        font-size: 1.1rem;
        color: #374151;
        margin-top: 24px;
      }

      .info-box {
        background: #eff6ff;
        border: 1px solid #bfdbfe;
        border-radius: 10px;
        padding: 16px 20px;
        margin-top: 24px;
        text-align: left;
      }

      .info-box p {
        color: #1e40af;
        font-size: 0.875rem;
        margin: 0;
        line-height: 1.5;
      }
    </style>
  </head>
  <body>

    <div class="container">
      <div class="header">
        <h1>Oral Defense Portal</h1>
        <p>Submit your essay and begin your defense</p>
      </div>

      <div class="content">
        <!-- Screen 1: Submission Form -->
        <div id="screen-submit" class="screen active">
          <form id="essayForm" onsubmit="handleSubmit(event)">
            <div class="form-group">
              <label for="name">Full Name</label>
              <input
                type="text"
                id="name"
                name="name"
                placeholder="Enter your full name"
                required
                autocomplete="name"
              >
            </div>

            <div class="form-group">
              <label for="essay">Your Essay</label>
              <textarea
                id="essay"
                name="essay"
                placeholder="Paste the complete text of your essay here..."
                required
                oninput="updateCharCount()"
              ></textarea>
              <div id="charCount" class="char-count">
                <span id="currentChars">0</span>&nbsp;/&nbsp;<span id="maxChars">15,000</span> characters
              </div>
            </div>

            <button type="submit" id="submitBtn" class="btn btn-primary">
              <span id="submitText">Submit Essay</span>
              <div id="submitSpinner" class="spinner" style="display: none;"></div>
            </button>
          </form>
        </div>

        <!-- Screen 2: Submission Success -->
        <div id="screen-success" class="screen">
          <div class="success-content">
            <div class="success-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
              </svg>
            </div>
            <h2>Essay Submitted Successfully</h2>
            <p>Your essay has been received and you're ready for your oral defense.</p>
            <div class="student-name" id="displayName">Student Name</div>
          </div>

          <div class="divider"></div>

          <div class="instructions">
            <h3>
              <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Before You Begin
            </h3>
            <p>When the defense starts, the AI examiner will ask you to paste your essay into the chat. Please have it ready to copy. You'll then answer questions about your work verbally.</p>
          </div>

          <button onclick="startDefense()" class="btn btn-success">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z" />
            </svg>
            Start Oral Defense
          </button>
        </div>

        <!-- Screen 3: Defense in Progress -->
        <div id="screen-defense" class="screen">
          <div class="defense-header">
            <span class="status-badge ready">
              <span class="dot"></span>
              Defense Active
            </span>
            <h2>Your Defense is in Progress</h2>
            <p>Speak clearly and answer the examiner's questions about your essay.</p>
          </div>

          <div id="widgetContainer" class="widget-container loading">
            Loading voice agent...
          </div>
        </div>

        <!-- Screen 4: Defense Complete -->
        <div id="screen-complete" class="screen">
          <div class="complete-content">
            <div class="complete-icon">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <h2>Defense Complete</h2>
            <p>Your oral defense has been recorded and submitted for review.</p>
            <div class="student-name" id="completeDisplayName">Student Name</div>
            <p class="thank-you">Thank you for completing your defense!</p>

            <div class="info-box">
              <p>Your instructor will review your essay and defense transcript. Grades will be posted according to your course schedule. You may now close this window.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

   <script src="https://unpkg.com/@elevenlabs/convai-widget-embed@beta" async type="text/javascript"></script>

    <script>
      // Configuration
      const MAX_CHARS = 15000;
      const AGENT_ID = "agent_7501kesm7cg3e53rznc4dnjckgt4";

      // State
      let currentSessionId = null;
      let studentName = null;
      let defenseActive = false;

      // Character count
      function updateCharCount() {
        const essay = document.getElementById('essay');
        const currentChars = document.getElementById('currentChars');
        const charCountDiv = document.getElementById('charCount');
        const count = essay.value.length;

        currentChars.textContent = count.toLocaleString();

        charCountDiv.classList.remove('warning', 'error');
        if (count > MAX_CHARS) {
          charCountDiv.classList.add('error');
        } else if (count > MAX_CHARS * 0.9) {
          charCountDiv.classList.add('warning');
        }
      }

      // Form submission
      function handleSubmit(event) {
        event.preventDefault();

        const essay = document.getElementById('essay').value;
        const name = document.getElementById('name').value;

        // Validate length
        if (essay.length > MAX_CHARS) {
          alert(`Your essay exceeds the maximum length of ${MAX_CHARS.toLocaleString()} characters. Please shorten it and try again.`);
          return;
        }

        // Show loading state
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');

        submitBtn.disabled = true;
        submitText.textContent = 'Submitting...';
        submitSpinner.style.display = 'block';

        // Submit to backend
        google.script.run
          .withSuccessHandler(onSubmitSuccess)
          .withFailureHandler(onSubmitError)
          .processSubmission({ name: name, essay: essay });
      }

      function onSubmitSuccess(response) {
        if (response.status === "success") {
          currentSessionId = response.sessionId;
          studentName = document.getElementById('name').value;

          // Update display
          document.getElementById('displayName').textContent = studentName;

          // Switch to success screen
          showScreen('screen-success');
        } else {
          alert("Error: " + response.message);
          resetSubmitButton();
        }
      }

      function onSubmitError(error) {
        alert("Server error: " + error.message);
        resetSubmitButton();
      }

      function resetSubmitButton() {
        const submitBtn = document.getElementById('submitBtn');
        const submitText = document.getElementById('submitText');
        const submitSpinner = document.getElementById('submitSpinner');

        submitBtn.disabled = false;
        submitText.textContent = 'Submit Essay';
        submitSpinner.style.display = 'none';
      }

      // Start defense
      function startDefense() {
        defenseActive = true;
        showScreen('screen-defense');
        initializeWidget();
      }

      function backToSuccess(event) {
        event.preventDefault();
        defenseActive = false;
        showScreen('screen-success');

        // Remove widget if it exists
        const container = document.getElementById('widgetContainer');
        container.innerHTML = '<span>Loading voice agent...</span>';
        container.classList.add('loading');
      }

      // Initialize 11Labs widget with session_id
      function initializeWidget() {
        const container = document.getElementById('widgetContainer');
        container.innerHTML = '';
        container.classList.remove('loading');

        // Create the widget element
        const widget = document.createElement('elevenlabs-convai');
        widget.setAttribute('agent-id', AGENT_ID);

        // Pass session_id as dynamic variable for webhook correlation
        widget.setAttribute('dynamic-variables', JSON.stringify({
          session_id: currentSessionId,
          student_name: studentName
        }));

        // Listen for call end events from the widget
        widget.addEventListener('elevenlabs-convai:call', handleCallEvent);
        widget.addEventListener('elevenlabs-convai:conversation', handleCallEvent);

        container.appendChild(widget);
      }

      // Handle call/conversation events from the widget
      function handleCallEvent(event) {
        console.log('Widget event:', event.type, event.detail);

        // Check for call ended status
        const detail = event.detail || {};
        if (detail.status === 'ended' ||
            detail.status === 'disconnected' ||
            event.type.includes('ended') ||
            event.type.includes('disconnected')) {
          showDefenseComplete();
        }
      }

      // Show the defense complete screen
      function showDefenseComplete() {
        // Only show if defense was active
        if (!defenseActive) return;
        defenseActive = false;

        // Update the student name on the complete screen
        document.getElementById('completeDisplayName').textContent = studentName;

        // Clear the widget container
        const container = document.getElementById('widgetContainer');
        container.innerHTML = '';

        // Show the completion screen
        showScreen('screen-complete');
      }

      // Screen management
      function showScreen(screenId) {
        document.querySelectorAll('.screen').forEach(screen => {
          screen.classList.remove('active');
        });
        document.getElementById(screenId).classList.add('active');
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        document.getElementById('maxChars').textContent = MAX_CHARS.toLocaleString();

        // Also listen for widget events at the document level (backup)
        document.addEventListener('elevenlabs-convai:call', handleCallEvent);
        document.addEventListener('elevenlabs-convai:conversation', handleCallEvent);

        // Listen for the specific call-ended event pattern
        document.addEventListener('elevenlabs-convai:call-ended', function() {
          showDefenseComplete();
        });
      });
    </script>

  </body>
</html>
